---
# Copyright 2016 PingCAP, Inc.
# The Playbook of TiDB

# use ec2.py dynamic inventory
# adapter for AWS ec2 machines

- name: perpare inventory
  hosts: localhost
  gather_facts: false
  tasks:
    - fail: msg="ec2 group not found, please use the right inventory"
      when: "{{ not ((groups.ec2 is defined) and groups.ec2) }}"

    - fail: msg="tidb servers not found"
      when: "{{ not ((groups.tag_Type_tidb is defined) and groups.tag_Type_tidb) }}"

    - fail: msg="pd servers not found"
      when: "{{ not ((groups.tag_Type_pd is defined) and groups.tag_Type_pd) }}"

    - fail: msg="tikv servers not found"
      when: "{{ not ((groups.tag_Type_tikv is defined) and groups.tag_Type_tikv) }}"

    - name: add tidb server group
      add_host:
        groups: tidb_servers
        hostname: "{{ item }}"
      with_items: "{{ groups.tag_Type_tidb }}"
    
    - name: add pd server group
      add_host:
        groups: pd_servers
        hostname: "{{ item }}"
      with_items: "{{ groups.tag_Type_pd }}"

    - name: add tikv server group
      add_host:
        groups: tikv_servers
        hostname: "{{ item }}"
      with_items: "{{ groups.tag_Type_tikv }}"

    - name: add monitoring server group
      add_host:
        groups: monitoring_servers
        hostname: "{{ item }}"
      with_items: "{{ groups.tag_Type_monitoring }}"

    - name: add monitored server if monitoring enables
      add_host:
        groups: monitoring_servers
        hostname: "{{ item }}"
      with_items: "{{ groups.tidb_servers + groups.pd_servers + groups.tikv_servers + groups.monitoring_servers }}"
      when: "{{ (groups.monitoring_servers is defined) and groups.monitoring_servers }}"

- name: set fact for all generated inventory
  hosts: all
  tasks:
    - set_fact:
        ansible_user: ubuntu

- include: cluster.yml
