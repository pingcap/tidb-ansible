---

- name: Preflight check - Does fio mixed randread and sequential write iops of deploy_dir disk meet requirement - randread
  fail:
    msg: 'fio mixed randread and sequential write test: randread iops of  deploy_dir disk is too low: {{ disk_mix_randread_iops }} < {{ min_ssd_mix_randread_iops }}, it is strongly recommended to use SSD disks for TiKV, TiDB and PD, or there might be performance issues.'
  when: disk_mix_randread_iops|int < min_ssd_mix_randread_iops|int

- name: Preflight check - Does fio mixed randread and sequential write iops of deploy_dir disk meet requirement - sequential write
  fail:
    msg: 'fio mixed randread and sequential write test: sequential write iops of deploy_dir disk is too low: {{ disk_mix_write_iops }} < {{ min_ssd_mix_write_iops }}, it is strongly recommended to use SSD disks for TiKV, TiDB and PD, or there might be performance issues.'
  when: disk_mix_write_iops|int < min_ssd_mix_write_iops|int

- debug:
    msg: "run command on server: {{ disk_randr_write_lat.cmd }}, and fio mixed randread and sequential write latency result: randread latency {{ disk_mix_randread_lat }} usec, sequential write latency {{ disk_mix_write_lat }} usec."

- name: Preflight check - Does fio mixed randread and sequential write latency of deploy_dir disk meet requirement - randread
  fail:
    msg: 'fio mixed randread and sequential write test: randread latency of  deploy_dir disk is too low: {{ disk_mix_randread_lat }} usec > {{ max_ssd_mix_randread_lat }} usec, it is strongly recommended to use SSD disks for TiKV, TiDB and PD, or there might be performance issues.'
  when: disk_mix_randread_lat|int > max_ssd_mix_randread_lat|int

- name: Preflight check - Does fio mixed randread and sequential write latency of deploy_dir disk meet requirement - sequential write
  fail:
    msg: 'fio mixed randread and sequential write test: sequential write latency of deploy_dir disk is too low: {{ disk_mix_write_lat }} usec > {{ max_ssd_mix_write_lat }} usec, it is strongly recommended to use SSD disks for TiKV, TiDB and PD, or there might be performance issues.'
  when: disk_mix_write_lat|int > max_ssd_mix_write_lat|int
