{% set my_ip = ansible_default_ipv4.address -%}

{% set my_peer_id = groups.pd_servers.index(inventory_hostname) + 1 -%}

{% set all_pd = [] -%}

{% for host in groups.pd_servers -%}
  {% set other_ip = hostvars[host].ansible_default_ipv4.address -%}
  {% set other_port = hostvars[host].pd_peer_port -%}
  {% set other_pd_name_surfix = groups.pd_servers.index(host) + 1 -%}
  {% set other_pd_name = pd_name_prefix ~ other_pd_name_surfix -%}
  {% set _ = all_pd.append("%s=http://%s:%s" % (other_pd_name, other_ip, other_port)) -%}
{% endfor -%}

{% set metric_host = hostvars[groups.monitoring_servers[0]].ansible_default_ipv4.address
    if groups.get('monitoring_servers', []) else '' -%}
{% set metric_port = hostvars[groups.monitoring_servers[0]].pushgateway_port if metric_host else '' -%}
{% set metric_interval = pd_metric_interval if metric_host else "0s" -%}

# PD Configuration.
# WARNING: This file was auto-generated. Do not edit!
#          All your edit might be overwritten!

# FIXME: not support server section yet
# [server]
# name = "{{ pd_name_prefix }}{{ my_peer_id }}"
# data-dir = "{{ pd_data_dir}}"

# client-urls = ""
# if not set, fallback to use ${client-urls}
# advertise-client-urls = ""

# peer-urls = ""
# if not set, fallback to use ${peer-urls}
# advertise-peer-urls = ""

# initial-cluster = ""
# initial-cluster-state = "new"
# join = ""

# log-level = ""
# log-file = ""

lease = 3
tso-save-interval = "3s"
max-peer-count = 3

[metric]
# prometheus client push interval, set "0s" to disable prometheus.
interval = "{{ metric_interval }}"

# prometheus pushgateway address, leaves it empty will disable prometheus.
address = "{{ metric_host }}:{{ metric_port }}"

[schedule]
min-region-count = 10
min-leader-count = 10
max-snapshot-count = 3
min-balance-diff-ratio = 0.01
max-store-down-duration = "1h"
leader-schedule-limit = 8
leader-schedule-interval = "1s"
storage-schedule-limit = 4
storage-schedule-interval = "1s"
replica-schedule-limit = 8
replica-schedule-interval = "1s"

[replication]
max-replicas = 3
location-labels = []