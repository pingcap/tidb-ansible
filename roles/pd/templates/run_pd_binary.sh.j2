#!/bin/bash
set -e
ulimit -n 1000000

# WARNING: This file was auto-generated. Do not edit!
#          All your edit might be overwritten!
DEPLOY_DIR={{ deploy_dir }}

cd "${DEPLOY_DIR}" || exit 1

{% set my_ip = hostvars[inventory_hostname].ansible_host | default(hostvars[inventory_hostname].inventory_hostname) -%}
{% set my_separator = "_" %}
{% set my_hostname = hostvars[inventory_hostname]['ansible_hostname'] | default(hostvars[inventory_hostname].inventory_hostname) -%}
{% set my_peer_id = my_separator ~ my_hostname %}

{% if enable_tls|default(false) %}
  {% set pd_scheme = 'https' -%}
{% endif %}

{% set all_pd = [] -%}
{% for host in groups.pd_servers -%}
  {% set other_ip = hostvars[host].ansible_host | default(hostvars[host].inventory_hostname) -%}
  {% set other_port = hostvars[host]['pd_peer_port'] -%}
  {% set other_pd_name_surfix = hostvars[host]['ansible_hostname'] | default(hostvars[host].inventory_hostname) -%}
  {% set other_pd_name = pd_name_prefix ~ my_separator ~ other_pd_name_surfix -%}
  {% set _ = all_pd.append("%s=%s://%s:%s" % (other_pd_name, pd_scheme, other_ip, other_port)) -%}
{% endfor -%}

exec bin/pd-server \
    --name="{{ pd_name_prefix }}{{ my_peer_id }}" \
    --client-urls="{{ pd_scheme }}://{{ my_ip }}:{{ pd_client_port }}" \
    --advertise-client-urls="{{ pd_scheme }}://{{ my_ip }}:{{ pd_client_port }}" \
    --peer-urls="{{ pd_scheme }}://{{ my_ip }}:{{ pd_peer_port }}" \
    --advertise-peer-urls="{{ pd_scheme }}://{{ my_ip }}:{{ pd_peer_port }}" \
    --data-dir="{{ pd_data_dir }}" \
    --initial-cluster="{{ all_pd | join(',') }}" \
    --config=conf/pd.toml \
    --log-file="{{ pd_log_dir }}/{{ pd_log_filename }}" 2>> "{{ pd_log_dir }}/{{ pd_stderr_filename }}"
