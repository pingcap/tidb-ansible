---

- set_fact:
    tidb_insight_dir: "{{ hostvars[groups.monitored_servers[0]].deploy_dir }}"

- set_fact:
    log_dir: "{{ pd_log_dir }}"
  when: "'pd_servers' in group_names"

- set_fact:
    log_dir: "{{ tikv_log_dir }}"
  when: "'tikv_servers' in group_names"

- set_fact:
    log_dir: "{{ tidb_log_dir }}"
  when: "'tidb_servers' in group_names"

- name: environment check (log directory)
  stat: path={{ log_dir }} get_md5=false get_checksum=false
  register: log_dir_st

- fail:
    msg: "{{ log_dir }} must exist and is a directory."
  when: log_dir_st.stat.isdir is not defined or log_dir_st.stat.isdir == False

- name: collect pd log
  shell: "python {{ tidb_insight_dir }}/scripts/collect-log.py --log-dir={{ log_dir }} --prefix=pd --retention={{ collect_log_recent_hours | default('2') }} --output={{ log_dir }} --alias={{ inventory_hostname }}"
  when:
    - "'pd_servers' in group_names"

- name: collect tikv log
  shell: "python {{ tidb_insight_dir }}/scripts/collect-log.py --log-dir={{ log_dir }} --prefix=tikv --retention={{ collect_log_recent_hours | default('2') }} --output={{ log_dir }} --alias={{ inventory_hostname }}"
  when:
    - "'tikv_servers' in group_names"

- name: collect tidb log
  shell: "python {{ tidb_insight_dir }}/scripts/collect-log.py --log-dir={{ log_dir }} --prefix=tidb --retention={{ collect_log_recent_hours | default('2') }} --output={{ log_dir }} --alias={{ inventory_hostname }}"
  when:
    - "'tidb_servers' in group_names"

- name: fetch pd log file
  fetch:
    src: "{{ log_dir }}/pd_{{ inventory_hostname }}.tar.gz"
    dest: "{{ fetch_tmp_dir }}/{{ inventory_hostname }}/"
    flat: yes
    validate_checksum: no
  when: "'pd_servers' in group_names"

- name: fetch tikv log file
  fetch:
    src: "{{ log_dir }}/tikv_{{ inventory_hostname }}.tar.gz"
    dest: "{{ fetch_tmp_dir }}/{{ inventory_hostname }}/"
    flat: yes
    validate_checksum: no
  when: "'tikv_servers' in group_names"

- name: fetch tidb log file
  fetch:
    src: "{{ log_dir }}/tidb_{{ inventory_hostname }}.tar.gz"
    dest: "{{ fetch_tmp_dir }}/{{ inventory_hostname }}/"
    flat: yes
    validate_checksum: no
  when: "'tidb_servers' in group_names"

- name: remove pd log file
  file:
    path: "{{ log_dir }}/{{ item }}"
    state: absent
  with_items:
    - "pd_{{ inventory_hostname }}.tar.gz"
  when: "'pd_servers' in group_names"

- name: remove tikv log file
  file:
    path: "{{ log_dir }}/{{ item }}"
    state: absent
  with_items:
    - "tikv_{{ inventory_hostname }}.tar.gz"
  when: "'tikv_servers' in group_names"

- name: remove tidb log file
  file:
    path: "{{ log_dir }}/{{ item }}"
    state: absent
  with_items:
    - "tidb_{{ inventory_hostname }}.tar.gz"
  when: "'tidb_servers' in group_names"
