---

# This play book is intend for one pass execution

- name: "Group nodes by OS distribution"
  hosts: all
  gather_facts: true
  tasks:
    - name: group hosts by distribution
      group_by: key="{{ ansible_distribution }}-{{ ansible_distribution_version }}"
      changed_when: false

- name: Set Time Zone
  hosts: Ubuntu-14.04
  gather_facts: false
  become: true
  tasks:
    - name: Set timezone variables
      copy: content='Asia/Shanghai'
            dest=/etc/timezone
            owner=root
            group=root
            mode=0644
            backup=yes
      notify:
        - update timezone
  handlers:
    - name: update timezone
      command: dpkg-reconfigure --frontend noninteractive tzdata

- name: do AWS host preparation
  hosts: Ubuntu-*
  gather_facts: false
  tasks:
    - name: disable apt key check
      lineinfile: >
        dest=/etc/apt/apt.conf.d/99skipkeycheck line="APT::Get::AllowUnauthenticated "true";"
        create=yes
      become: true
      
    - name: change apt mirror.list
      copy: src=sources.list dest=/etc/apt/sources.list mode=0644
      become: true
 
    - name: add apt-fast to apt sources.list.d
      lineinfile: >
        dest=/etc/apt/sources.list.d/saiarcot895-myppa-trusty.list
        line="deb http://ppa.launchpad.net/saiarcot895/myppa/ubuntu trusty main" 
        create=yes
      become: true

    - name: install apt-fast
      apt: name={{ item }} update_cache=yes
      become: true
      with_items:
        - apt-fast

    - name: add docker to apt sources.list.d
      lineinfile: > 
        dest=/etc/apt/sources.list.d/docker.list
        line="deb https://mirrors.tuna.tsinghua.edu.cn/docker/apt/repo ubuntu-trusty main"
        create=yes 
      become: true

    - name: update apt cache
      shell: apt-fast -y update

    # --skip-tags docker
    - name: install docker
      tags:
        - docker
      shell: >-
        creates=/usr/bin/docker
        apt-fast -y install docker-engine
      become: true

    - name: add user to docker group
      tags:
        - docker
      user: name=ubuntu groups=docker append=yes
      become: true

    - name: install perf/systemtab/unzip/ntp/zip
      shell: >-
        apt-fast -y install linux-tools-$(uname -r) systemtap unzip ntp zip

    - name: add user to docker group
      user: name=ubuntu groups=stapusr append=yes
      become: true

    - name: add user to docker group
      user: name=ubuntu groups=stapdev append=yes
      become: true

    - name: install FlameGraph - create dir
      file: path=/opt/FlameGraph state=directory mode=0755
      become: true

    - name: install FlameGraph - install scripts
      unarchive:
        creates: /opt/FlameGraph/flamegraph.pl
        src: "{{ resources_dir }}/FlameGraph.zip"
        dest: /opt/FlameGraph/
        mode: 0755
        exclude:
          - demos
          - docs
          - test
      become: true

    - name: install FlameGraph - change dir
      shell: >-
        creates=/opt/FlameGraph/flamegraph.pl
        chdir=/opt/FlameGraph
        mv ./FlameGraph-master/* ./ && 
        rm -r ./FlameGraph-master
      become: true
